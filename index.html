<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–≤–æ—Ä—è—â–∏–π –∞–≤–∞—Ç–∞—Ä: –°—Ü–µ–Ω–∞—Ä–∏–π –ó–∞–¥–∞–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #120C1C; --surface: #1E1234; --primary: #A450F3; --accent: #F72585; --text: #EAE2FF; --border: #3A2E59; --input-bg: #0b0711; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        #editor-container { max-width: 1100px; width: 100%; background-color: var(--surface); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h1 { text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px var(--accent); }
        .editor-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        .col { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Preview */
        #preview-box {
            position: relative;
            background-image: linear-gradient(45deg, #181818 25%, transparent 25%), linear-gradient(-45deg, #181818 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #181818 75%), linear-gradient(-45deg, transparent 75%, #181818 75%);
            background-size: 20px 20px; background-color: #222; border: 1px dashed #555; border-radius: 20px;
            overflow: hidden; width: 100%; height: 600px; display: flex; justify-content: center; align-items: center;
        }
        
        .widget-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* Chat UI Styles (Matches generated code) */
        .avatar-ring { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--border); background: var(--bg); cursor: pointer; position: absolute; z-index: 10; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .avatar-ring:hover { transform: scale(1.05); }
        .avatar-ring img { width: 90%; height: 90%; border-radius: 50%; object-fit: cover; }
        
        .chat-window { width: 90%; height: 95%; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; display: flex; flex-direction: column; position: absolute; z-index: 20; opacity: 0; pointer-events: none; transform: scale(0.9); transition: all 0.3s; box-shadow: 0 10px 50px rgba(0,0,0,0.7); }
        .chat-window.open { opacity: 1; pointer-events: all; transform: scale(1); }
        
        .chat-header { padding: 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-info { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .close-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 24px; line-height: 1; }
        
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; align-items: flex-end; gap: 8px; max-width: 90%; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        
        .msg-bot { align-self: flex-start; }
        .msg-bot .bubble { background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; }
        .msg-user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-user .bubble { background: var(--accent); color: white; border-bottom-right-radius: 2px; }
        
        .chat-media { margin-top: 8px; border-radius: 10px; overflow: hidden; max-width: 100%; border: 1px solid rgba(255,255,255,0.2); }
        .chat-media img { width: 100%; height: auto; display: block; }
        .chat-audio { width: 100%; margin-top: 5px; height: 30px; }

        .choice-btns { display: flex; gap: 10px; margin-top: 5px; margin-left: 36px; }
        .choice-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid var(--accent); background: transparent; color: white; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .choice-btn:hover { background: var(--accent); }
        .choice-btn.no { border-color: #666; }
        .choice-btn.no:hover { background: #666; }

        .chat-input-area { padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border); border-radius: 20px; padding: 10px 15px; color: white; outline: none; }
        .send-btn { background: var(--accent); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .send-btn:hover { transform: scale(1.1); }
        .send-btn svg { width: 18px; fill: white; margin-left: 2px; }

        /* Settings */
        .custom-file { padding: 12px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); text-align: center; cursor: pointer; border-radius: 8px; position: relative; margin-bottom: 10px; display:flex; flex-direction: column; align-items: center; gap: 5px; }
        .file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        
        input[type="text"], textarea { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: white; font-family: inherit; }
        input[type="color"] { width: 100%; height: 40px; border: none; background: none; cursor: pointer; }
        
        .section-title { font-weight: 600; color: var(--primary); margin-top: 15px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(90deg, #A450F3, #F72585); color: white; font-weight: 600; cursor: pointer; margin-top: 20px; }
        
        textarea.code-output { width: 100%; height: 80px; background: #0b0711; border: 1px solid var(--border); color: #888; border-radius: 8px; padding: 10px; resize: none; font-size:11px;}
        .hint { font-size: 0.8rem; color: #aaa; }
        .status-ok { color: #4ade80; font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="editor-container">
    <h1>–ì–æ–≤–æ—Ä—è—â–∏–π –∞–≤–∞—Ç–∞—Ä: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏–π</h1>
    <div class="editor-layout">
        <!-- Preview -->
        <div class="col" style="flex: 1.5;">
            <div id="preview-box">
                <div class="widget-wrapper">
                    <div class="avatar-ring" id="prev-ring" onclick="toggleChat()">
                        <img id="prev-img-ring" src="">
                    </div>
                    <div class="chat-window" id="prev-chat">
                        <div class="chat-header">
                            <div class="header-info">
                                <img id="prev-img-head" class="header-avatar" src="">
                                <span>–ê–≤–∞—Ç–∞—Ä</span>
                            </div>
                            <button class="close-btn" onclick="toggleChat()">√ó</button>
                        </div>
                        <div class="chat-messages" id="prev-msgs"></div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" id="prev-in" placeholder="–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç...">
                            <button class="send-btn" onclick="simSend()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>
            <p style="text-align:center; color:#888; font-size:0.9rem; margin-top:5px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä—É–≥, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π.</p>
        </div>

        <!-- Settings -->
        <div class="col">
            <span class="section-title">1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ê–≤–∞—Ç–∞—Ä–∞</span>
            <label class="custom-file">
                <span id="label-img">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ê–≤–∞—Ç–∞—Ä</span>
                <input type="file" id="inp-img" accept="image/*" class="file-input">
            </label>
            <span style="font-weight:600">–¶–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π:</span>
            <input type="color" id="inp-accent" value="#F72585">

            <span class="section-title">2. –°—Ü–µ–Ω–∞—Ä–∏–π: –°—Ç–∞—Ä—Ç</span>
            <span style="font-weight:600">–í–æ–ø—Ä–æ—Å "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å":</span>
            <input type="text" id="inp-q-ready" value="–¢—ã –≥–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?">
            
            <span class="section-title">3. –°—Ü–µ–Ω–∞—Ä–∏–π: –û—Ç–≤–µ—Ç "–ù–µ—Ç"</span>
            <span style="font-weight:600">–°–æ–æ–±—â–µ–Ω–∏–µ –∂–∞–ª–æ—Å—Ç–∏:</span>
            <input type="text" id="inp-msg-sorry" value="–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å. –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –∫–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤!">

            <span class="section-title">4. –°—Ü–µ–Ω–∞—Ä–∏–π: –û—Ç–≤–µ—Ç "–î–∞" (–ó–∞–¥–∞–Ω–∏–µ)</span>
            <span style="font-weight:600">–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è:</span>
            <textarea id="inp-msg-task" style="height: 80px" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å...">–ü–æ—Å–ª—É—à–∞–π –∞—É–¥–∏–æ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É. –ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å?</textarea>

            <label class="custom-file" style="border-color: #A450F3;">
                <span>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                <input type="file" id="inp-task-img" accept="image/*" class="file-input">
                <div id="st-task-img" class="status-ok"></div>
            </label>

            <label class="custom-file" style="border-color: #A450F3;">
                <span>üéµ –ê—É–¥–∏–æ –∑–∞–¥–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                <input type="file" id="inp-task-aud" accept="audio/*" class="file-input">
                <div id="st-task-aud" class="status-ok"></div>
            </label>

            <span class="section-title">5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (–°–ª–æ–≤–∞—Ä—å)</span>
            <div class="hint">–ü–∞—Ä—ã: <b>–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ - –†–µ–∞–∫—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∞</b></div>
            <textarea id="inp-dict" style="height: 100px; font-family: monospace" placeholder="–ö–æ—Ç - –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –≠—Ç–æ –∫–æ—Ç.
–°–æ–±–∞–∫–∞ - –í–µ—Ä–Ω–æ, —ç—Ç–æ —Å–æ–±–∞–∫–∞."></textarea>
            
            <span style="font-weight:600">–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–ª:</span>
            <input type="text" id="inp-unknown" value="–ù–µ —Å–æ–≤—Å–µ–º —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.">

            <button id="btn-copy" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <textarea id="output-code" class="code-output" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥..."></textarea>
        </div>
    </div>
</div>

<script>
    // Embedded Sounds (Base64) - Short & Lightweight
    const sndPop = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABMmYXbWxpbmUAbXAzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"; 
    // Real short click sound
    const realClick = "data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAACAgEBAQAAAA==";
    // Real short notification
    const realPing = "data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQcAAAAAAP8A/wD/AP8A/wD/AP8AAA=="; 

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (–∫–æ—Ä–æ—Ç–∫–∏–µ –±–∏–ø—ã)
    const audioSend = "data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoAAACAAAAAgAAAAACAAAAAgAAAAICAAIAAgIDAwMDA3t7e3qCgoKDf39/fAA=="; // Typewriter click sim
    const audioRecv = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQQAAAAAAA=="; // Ping sim

    // Default Assets
    const defBot = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cccccc'%3E%3Cpath d='M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2'/%3E%3C/svg%3E";
    const defUser = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23888888'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

    const els = {
        imgRing: document.getElementById('prev-img-ring'),
        imgHead: document.getElementById('prev-img-head'),
        chatWin: document.getElementById('prev-chat'),
        msgs: document.getElementById('prev-msgs'),
        inp: document.getElementById('prev-in'),
        // Inputs
        file: document.getElementById('inp-img'),
        taskImg: document.getElementById('inp-task-img'),
        taskAud: document.getElementById('inp-task-aud'),
        
        qReady: document.getElementById('inp-q-ready'),
        msgSorry: document.getElementById('inp-msg-sorry'),
        msgTask: document.getElementById('inp-msg-task'),
        
        dict: document.getElementById('inp-dict'),
        unk: document.getElementById('inp-unknown'),
        acc: document.getElementById('inp-accent'),
        code: document.getElementById('output-code'),
        copy: document.getElementById('btn-copy'),
        label: document.getElementById('label-img')
    };

    let state = { 
        avatar: defBot, 
        taskImg: null, 
        taskAud: null,
        open: false,
        phase: 0 // 0=Ask Ready, 1=Wait Choice, 2=Task Active, 3=Sorry End
    };

    // Init
    els.imgRing.src = state.avatar;
    els.imgHead.src = state.avatar;

    // File Handlers
    const handleFile = (input, key, statusId) => {
        input.onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = v => {
                    state[key] = v.target.result;
                    if(statusId) document.getElementById(statusId).innerText = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ";
                    if(key === 'avatar') {
                        els.imgRing.src = state.avatar;
                        els.imgHead.src = state.avatar;
                        els.label.innerText = "‚úÖ –ê–≤–∞—Ç–∞—Ä –≥–æ—Ç–æ–≤";
                    }
                    if(state.open) restartChat();
                };
                r.readAsDataURL(f);
            }
        };
    };

    handleFile(els.file, 'avatar');
    handleFile(els.taskImg, 'taskImg', 'st-task-img');
    handleFile(els.taskAud, 'taskAud', 'st-task-aud');

    window.toggleChat = () => {
        state.open = !state.open;
        if(state.open) {
            els.chatWin.classList.add('open');
            restartChat();
        } else {
            els.chatWin.classList.remove('open');
        }
    };

    function restartChat() {
        els.msgs.innerHTML = '';
        state.phase = 0;
        // Ask Ready
        addMsg('bot', els.qReady.value);
        addChoices();
    }

    function addChoices() {
        const div = document.createElement('div');
        div.className = 'choice-btns';
        div.innerHTML = `
            <button class="choice-btn" onclick="handleChoice(true)">–î–∞</button>
            <button class="choice-btn no" onclick="handleChoice(false)">–ù–µ—Ç</button>
        `;
        els.msgs.appendChild(div);
        els.msgs.scrollTop = els.msgs.scrollHeight;
    }

    window.handleChoice = (isYes) => {
        // Remove buttons
        const btns = els.msgs.querySelector('.choice-btns');
        if(btns) btns.remove();

        if(isYes) {
            // Task
            addMsg('bot', els.msgTask.value, state.taskImg, state.taskAud);
            state.phase = 2; // Task Active
        } else {
            // Sorry
            addMsg('bot', els.msgSorry.value);
            state.phase = 3; // End
        }
    };

    function addMsg(role, text, img, aud) {
        const div = document.createElement('div');
        div.className = `message msg-${role}`;
        
        const avatar = document.createElement('img');
        avatar.className = 'msg-avatar';
        avatar.src = role === 'bot' ? state.avatar : defUser;
        
        const content = document.createElement('div');
        content.style.display = 'flex'; 
        content.style.flexDirection = 'column';
        content.style.maxWidth = '100%';

        const bub = document.createElement('div');
        bub.className = 'bubble';
        if(role === 'user') bub.style.background = els.acc.value;
        bub.innerText = text;
        content.appendChild(bub);

        if(img) {
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'chat-media';
            mediaDiv.innerHTML = `<img src="${img}">`;
            content.appendChild(mediaDiv);
        }
        if(aud) {
            const audDiv = document.createElement('audio');
            audDiv.className = 'chat-audio';
            audDiv.controls = true;
            audDiv.src = aud;
            content.appendChild(audDiv);
        }

        div.appendChild(avatar);
        div.appendChild(content);
        
        if(role === 'user') { div.insertBefore(content, avatar); }
        
        els.msgs.appendChild(div);
        els.msgs.scrollTop = els.msgs.scrollHeight;
    }

    // Parse Dictionary
    function parseDictionary() {
        const lines = els.dict.value.split('\n');
        const db = {};
        lines.forEach(line => {
            const parts = line.split('-');
            if(parts.length >= 2) {
                const key = parts[0].trim().toLowerCase();
                const val = parts.slice(1).join('-').trim();
                if(key) db[key] = val;
            }
        });
        return db;
    }

    window.simSend = () => {
        const val = els.inp.value.trim();
        if(!val) return;
        addMsg('user', val);
        els.inp.value = '';
        
        if(state.phase !== 2) return; // Only answer if task active

        const db = parseDictionary();
        const key = val.toLowerCase();
        let answer = db[key]; // Exact
        
        if(!answer) {
             const found = Object.keys(db).find(k => k.includes(key) || key.includes(k));
             if(found) answer = db[found];
        }
        if(!answer) answer = els.unk.value;
        
        setTimeout(() => addMsg('bot', answer), 400);
    };

    // Live update
    els.acc.oninput = () => {
        document.querySelector('.send-btn').style.background = els.acc.value;
    };

    // Generate Code
    els.copy.onclick = () => {
        const code = getCode();
        els.code.value = code;
        els.code.select();
        document.execCommand('copy');
        els.copy.innerText = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
        setTimeout(() => els.copy.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥", 2000);
    };

    function getCode() {
        const uid = "task2-" + Math.random().toString(36).substr(2,6);
        const av = state.avatar;
        const us = defUser;
        const col = els.acc.value;
        
        const txtReady = els.qReady.value;
        const txtSorry = els.msgSorry.value;
        const txtTask = els.msgTask.value;
        
        const tImg = state.taskImg || "";
        const tAud = state.taskAud || "";
        
        const dictObj = JSON.stringify(parseDictionary());
        const txtUnk = els.unk.value;

        // REAL Embedded Sounds for Final Code
        // Click (Mechanical)
        const sClick = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABMmYXbWxpbmUAbXAzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"; 
        // Ping (Notification)
        const sPing = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABMmYXbWxpbmUAbXAzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"; 

        return `
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="margin:0;padding:0;width:100%;height:100%;background:transparent;overflow:hidden;font-family:sans-serif;">
<style>
* { box-sizing: border-box; }
#${uid} { width:100%; height:100%; display:flex; justify-content:center; align-items:center; position:relative; }

/* Ring */
#${uid} .ring { width:90px; height:90px; border-radius:50%; background:#1E1234; border:3px solid rgba(255,255,255,0.3); cursor:pointer; display:flex; justify-content:center; align-items:center; box-shadow:0 5px 15px rgba(0,0,0,0.4); transition:0.3s; z-index:1; }
#${uid} .ring:hover { transform:scale(1.05); }
#${uid} .ring img { width:90%; height:90%; border-radius:50%; object-fit:cover; }

/* Chat */
#${uid} .win { position:absolute; width:98%; height:98%; background:#120C1C; border-radius:15px; border:1px solid #3A2E59; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,0.6); opacity:0; pointer-events:none; transform:scale(0.9); transition:0.3s; z-index:2; color:#fff; }
#${uid} .win.show { opacity:1; pointer-events:all; transform:scale(1); }

#${uid} .head { padding:10px; background:rgba(255,255,255,0.05); border-bottom:1px solid #3A2E59; display:flex; justify-content:space-between; align-items:center; }
#${uid} .prof { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:bold; }
#${uid} .prof img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
#${uid} .cls { background:none; border:none; color:#888; font-size:20px; cursor:pointer; }

#${uid} .logs { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; scrollbar-width:thin; }
#${uid} .row { display:flex; gap:6px; max-width:90%; align-items:flex-end; font-size:13px; line-height:1.4; }
#${uid} .bot { align-self:flex-start; }
#${uid} .usr { align-self:flex-end; flex-direction:row-reverse; }
#${uid} .av { width:24px; height:24px; border-radius:50%; object-fit:cover; flex-shrink:0; }
#${uid} .cnt { display:flex; flex-direction:column; gap:4px; max-width:100%; }

#${uid} .txt { padding:8px 12px; border-radius:15px; word-wrap:break-word; }
#${uid} .bot .txt { background:rgba(255,255,255,0.1); border-bottom-left-radius:2px; }
#${uid} .usr .txt { background:${col}; color:#fff; border-bottom-right-radius:2px; }

#${uid} .media { border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.2); margin-top:4px; }
#${uid} .media img { width:100%; display:block; }
#${uid} audio { width:100%; height:25px; margin-top:4px; }

#${uid} .btns { display:flex; gap:8px; margin-left:30px; margin-top:-5px; }
#${uid} .b-ch { padding:6px 16px; border-radius:20px; border:1px solid ${col}; background:none; color:#fff; cursor:pointer; font-size:12px; }
#${uid} .b-ch:hover { background:${col}; }
#${uid} .b-no { border-color:#666; }
#${uid} .b-no:hover { background:#666; }

#${uid} .inp { padding:8px; background:rgba(0,0,0,0.2); border-top:1px solid #3A2E59; display:flex; gap:6px; }
#${uid} input { flex:1; background:#0b0711; border:1px solid #3A2E59; border-radius:20px; padding:8px 12px; color:#fff; outline:none; }
#${uid} .snd { width:34px; height:34px; border-radius:50%; background:${col}; border:none; color:#fff; cursor:pointer; display:flex; justify-content:center; align-items:center; }
#${uid} .snd svg { width:16px; fill:white; margin-left:2px; }
</style>

<div id="${uid}">
    <div class="ring" id="r-${uid}"><img src="${av}"></div>
    <div class="win" id="w-${uid}">
        <div class="head">
            <div class="prof"><img src="${av}"><span>–ê–≤–∞—Ç–∞—Ä</span></div>
            <button class="cls" id="c-${uid}">√ó</button>
        </div>
        <div class="logs" id="l-${uid}"></div>
        <div class="inp">
            <input type="text" id="i-${uid}" placeholder="–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç...">
            <button class="snd" id="s-${uid}"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>
    <audio id="ac-${uid}" src="${sClick}"></audio>
    <audio id="ap-${uid}" src="${sPing}"></audio>
</div>

<script>
(function(){
    var r = document.getElementById('r-${uid}');
    var w = document.getElementById('w-${uid}');
    var c = document.getElementById('c-${uid}');
    var l = document.getElementById('l-${uid}');
    var i = document.getElementById('i-${uid}');
    var s = document.getElementById('s-${uid}');
    
    var sc = document.getElementById('ac-${uid}');
    var sp = document.getElementById('ap-${uid}');
    
    // Config
    var db = ${dictObj};
    var tImg = "${tImg}";
    var tAud = "${tAud}";
    var txts = { ready: "${txtReady}", sorry: "${txtSorry}", task: "${txtTask}", unk: "${txtUnk}" };
    
    var active = false;

    // Trigger sound on interact to unlock
    function playSnd(type) {
        var a = type===1 ? sc : sp;
        a.currentTime = 0;
        a.play().catch(function(){}); 
    }

    r.onclick = function(){ 
        w.classList.add('show'); 
        r.style.opacity='0'; r.style.pointerEvents='none';
        l.innerHTML = '';
        active = false;
        // Step 1: Ready?
        playSnd(2);
        add('bot', txts.ready);
        showBtns();
    };
    c.onclick = function(){ w.classList.remove('show'); r.style.opacity='1'; r.style.pointerEvents='all'; };

    function mkRow(who) {
        var d = document.createElement('div'); d.className = 'row ' + who;
        var im = document.createElement('img'); im.className = 'av'; im.src = who==='bot'?"${av}":"${us}";
        var cnt = document.createElement('div'); cnt.className = 'cnt';
        d.appendChild(im); d.appendChild(cnt);
        if(who==='usr') { d.insertBefore(cnt, im); }
        return d;
    }

    function add(who, txt, img, aud) {
        var d = mkRow(who);
        var cnt = d.querySelector('.cnt');
        
        if(txt) {
            var t = document.createElement('div'); t.className='txt'; t.innerText=txt;
            cnt.appendChild(t);
        }
        if(img) {
            var md = document.createElement('div'); md.className='media';
            md.innerHTML = '<img src="'+img+'">';
            cnt.appendChild(md);
        }
        if(aud) {
            var ad = document.createElement('audio'); ad.controls=true; ad.src=aud;
            cnt.appendChild(ad);
        }
        l.appendChild(d); l.scrollTop = l.scrollHeight;
    }

    function showBtns() {
        var d = document.createElement('div'); d.className='btns';
        d.id = 'btns-${uid}';
        d.innerHTML = '<button class="b-ch" onclick="window.ans${uid}(1)">–î–∞</button><button class="b-ch b-no" onclick="window.ans${uid}(0)">–ù–µ—Ç</button>';
        l.appendChild(d); l.scrollTop = l.scrollHeight;
    }

    window.ans${uid} = function(yes) {
        var b = document.getElementById('btns-${uid}');
        if(b) b.remove();
        playSnd(1); // Click sound

        if(yes) {
            add('bot', txts.task, tImg, tAud);
            active = true;
            playSnd(2);
        } else {
            add('bot', txts.sorry);
            active = false;
            playSnd(2);
        }
    };

    function send() {
        var v = i.value.trim();
        if(!v) return;
        playSnd(1);
        
        add('usr', v);
        i.value = '';

        if(!active) return; // Ignore if not in task

        var k = v.toLowerCase();
        var ans = db[k];
        if(!ans) {
             var f = Object.keys(db).find(x => x.includes(k) || k.includes(x));
             if(f) ans = db[f];
        }
        if(!ans) ans = txts.unk;

        setTimeout(function(){ 
            add('bot', ans); 
            playSnd(2);
        }, 500);
    }

    s.onclick = send;
    i.onkeypress = function(e){ if(e.key==='Enter') send(); };
})();
<\/script>
</body>
</html>`;
    }
</script>
</body>
</html>
