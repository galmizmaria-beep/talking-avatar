<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–≤–∏–∑–∞ (Fixed Media)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #120C1C; --surface: #1E1234; --primary: #A450F3; --accent: #F72585; --text: #EAE2FF; --border: #3A2E59; --input-bg: #0b0711; --danger: #ff4757; --success: #2ecc71; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        #editor-container { max-width: 1250px; width: 100%; background-color: var(--surface); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h1 { text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px var(--accent); }
        .editor-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        .col { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Preview Area */
        #preview-box {
            position: relative;
            background-image: linear-gradient(45deg, #181818 25%, transparent 25%), linear-gradient(-45deg, #181818 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #181818 75%), linear-gradient(-45deg, transparent 75%, #181818 75%);
            background-size: 20px 20px; background-color: #222; border: 1px dashed #555; border-radius: 20px;
            overflow: hidden; width: 100%; height: 700px; display: flex; justify-content: center; align-items: center;
        }
        .widget-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }

        /* WIDGET STYLES (Shared) */
        .avatar-ring { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--border); background: var(--bg); cursor: pointer; position: absolute; z-index: 10; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .avatar-ring:hover { transform: scale(1.05); }
        .avatar-ring img { width: 90%; height: 90%; border-radius: 50%; object-fit: cover; }
        
        .chat-window { width: 90%; height: 95%; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; display: flex; flex-direction: column; position: absolute; z-index: 20; opacity: 0; pointer-events: none; transform: scale(0.9); transition: all 0.3s; box-shadow: 0 10px 50px rgba(0,0,0,0.7); }
        .chat-window.open { opacity: 1; pointer-events: all; transform: scale(1); }
        
        .chat-header { padding: 12px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-info { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; }
        .header-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .timer-display { font-family: monospace; font-size: 14px; background: #000; padding: 2px 6px; border-radius: 4px; color: var(--accent); display: none; }
        .close-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 24px; line-height: 1; }
        
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; align-items: flex-end; gap: 8px; max-width: 90%; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        
        .bubble-cont { display: flex; flex-direction: column; gap: 6px; max-width: 100%; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        .msg-bot { align-self: flex-start; }
        .msg-bot .bubble { background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; }
        .msg-user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-user .bubble { background: var(--accent); color: white; border-bottom-right-radius: 2px; }
        
        /* Media inside chat */
        .chat-media { border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); max-width: 250px; }
        .chat-media img { width: 100%; height: auto; display: block; }
        .chat-audio { width: 200px; height: 35px; }

        /* Options Buttons */
        .opt-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; margin-left: 36px; }
        .opt-btn { background: transparent; border: 1px solid var(--accent); color: white; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .opt-btn:hover { background: var(--accent); }

        .chat-input-area { padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border); border-radius: 20px; padding: 10px 15px; color: white; outline: none; }
        .send-btn { background: var(--accent); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .send-btn:hover { transform: scale(1.1); }
        .send-btn svg { width: 18px; fill: white; margin-left: 2px; }

        /* --- Editor UI --- */
        .custom-file { padding: 10px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); text-align: center; cursor: pointer; border-radius: 8px; position: relative; display:flex; flex-direction:column; align-items:center; }
        .file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: white; font-family: inherit; }
        input[type="color"] { width: 100%; height: 40px; border: none; background: none; cursor: pointer; }
        
        .section-title { font-weight: 600; color: var(--primary); margin-top: 10px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        
        /* Quest Builder */
        #quest-container { max-height: 400px; overflow-y: auto; padding-right: 5px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.2); }
        .q-card { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; }
        .q-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .q-type { font-size: 0.8rem; background: var(--primary); padding: 2px 6px; border-radius: 4px; }
        .q-del { background: var(--danger); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        
        .q-media-bar { display: flex; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .media-btn { flex: 1; position: relative; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 6px; color: #aaa; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 8px; transition: 0.2s; font-size: 0.85rem; }
        .media-btn:hover { background: rgba(255,255,255,0.05); }
        .media-btn.active { border-color: var(--success); color: var(--success); background: rgba(46, 204, 113, 0.1); }
        
        .q-input-group { margin-bottom: 8px; }
        .q-label { font-size: 0.75rem; color: #aaa; margin-bottom: 2px; display: block; }
        .q-inp { width: 100%; padding: 8px; background: #000; border: 1px solid var(--border); color: white; border-radius: 4px; font-size: 0.9rem; }
        
        .add-btn { background: var(--border); border: 1px dashed #888; color: #888; width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .add-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(90deg, #A450F3, #F72585); color: white; font-weight: 600; cursor: pointer; margin-top: 20px; }
        textarea.code-output { width: 100%; height: 80px; background: #0b0711; border: 1px solid var(--border); color: #888; border-radius: 8px; padding: 10px; resize: none; font-size:11px;}
    </style>
</head>
<body>

<div id="editor-container">
    <h1>–ì–æ–≤–æ—Ä—è—â–∏–π –∞–≤–∞—Ç–∞—Ä: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–≤–∏–∑–∞</h1>
    <div class="editor-layout">
        
        <!-- PREVIEW -->
        <div class="col" style="flex: 1.5;">
            <div id="preview-box">
                <div class="widget-wrapper">
                    <div class="avatar-ring" id="prev-ring" onclick="toggleChat()">
                        <img id="prev-img-ring" src="">
                    </div>
                    <div class="chat-window" id="prev-chat">
                        <div class="chat-header">
                            <div class="header-info">
                                <img id="prev-img-head" class="header-avatar" src="">
                                <span>–ê–≤–∞—Ç–∞—Ä</span>
                            </div>
                            <div id="prev-timer" class="timer-display">00:00</div>
                            <button class="close-btn" onclick="toggleChat()">√ó</button>
                        </div>
                        <div class="chat-messages" id="prev-msgs"></div>
                        <div class="chat-input-area" id="prev-input-area">
                            <input type="text" class="chat-input" id="prev-in" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
                            <button class="send-btn" onclick="simSend()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>
            <p style="text-align:center; color:#888; font-size:0.9rem; margin-top:5px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä—É–≥, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä—É.</p>
        </div>

        <!-- EDITOR -->
        <div class="col">
            <span class="section-title">1. –ê–≤–∞—Ç–∞—Ä –∏ –°—Ç–∏–ª—å</span>
            <div class="row">
                <label class="custom-file" style="flex:1">
                    <span id="label-img">üìÇ –ê–≤–∞—Ç–∞—Ä</span>
                    <input type="file" id="inp-img" accept="image/*" class="file-input">
                </label>
                <div style="flex:1">
                    <span style="font-size:0.8rem">–¶–≤–µ—Ç:</span>
                    <input type="color" id="inp-accent" value="#F72585">
                </div>
            </div>

            <span class="section-title">2. –¢–∞–π–º–µ—Ä</span>
            <div class="row">
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="inp-timer-on"> –í–∫–ª—é—á–∏—Ç—å
                </label>
                <input type="number" id="inp-timer-min" placeholder="–ú–∏–Ω" value="5" min="1" max="30" style="width:70px">
                <span style="font-size:0.8rem">–º–∏–Ω.</span>
            </div>

            <span class="section-title">3. –°–ø–∏—Å–æ–∫ –í–æ–ø—Ä–æ—Å–æ–≤</span>
            <div id="quest-container"></div>
            <button class="add-btn" onclick="addQuest()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>

            <span class="section-title">4. –°–æ–æ–±—â–µ–Ω–∏—è –§–∏–Ω–∞–ª–∞</span>
            <div class="q-input-group">
                <span class="q-label">–ü–æ–±–µ–¥–∞ (–≤—Å–µ –≤–µ—Ä–Ω–æ):</span>
                <input type="text" id="inp-win" value="–ú–æ–ª–æ–¥–µ—Ü! –¢—ã –ø—Ä–æ—à–µ–ª –∏—Å–ø—ã—Ç–∞–Ω–∏–µ.">
            </div>
            <div class="q-input-group">
                <span class="q-label">–ü—Ä–æ–∏–≥—Ä—ã—à (–æ—à–∏–±–∫–∞ / –≤—Ä–µ–º—è –≤—ã—à–ª–æ):</span>
                <input type="text" id="inp-lose" value="–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.">
            </div>

            <button id="btn-copy" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <textarea id="output-code" class="code-output" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥..."></textarea>
        </div>
    </div>
</div>

<!-- Hidden Audios for Preview -->
<audio id="prev-aud-click"></audio>
<audio id="prev-aud-ping"></audio>
<audio id="prev-aud-type"></audio>

<script>
    // --- DATA & STATE ---
    const defBot = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cccccc'%3E%3Cpath d='M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2'/%3E%3C/svg%3E";
    const defUser = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23888888'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

    // BASE64 SOUNDS
    const sType = "data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAACAgEBAQAAAA=="; // Placeholder click
    const sClick = "data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoAAACAAAAAgAAAAAA="; // Placeholder click
    const sPing = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABMmYXbWxpbmUAbXAzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"; // Placeholder ping

    let state = {
        avatar: defBot,
        quests: [
            { type: 'text', q: '–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2?', a: '4', opts: '', img: null, aud: null },
            { type: 'choice', q: '–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?', a: '–ü–∞—Ä–∏–∂', opts: '–õ–æ–Ω–¥–æ–Ω,–ü–∞—Ä–∏–∂,–ë–µ—Ä–ª–∏–Ω', img: null, aud: null }
        ],
        chatOpen: false,
        gameActive: false,
        qIndex: 0,
        timerVal: 300,
        interval: null
    };

    // --- DOM ELEMENTS ---
    const els = {
        questCont: document.getElementById('quest-container'),
        imgInp: document.getElementById('inp-img'),
        prevRing: document.getElementById('prev-img-ring'),
        prevHead: document.getElementById('prev-img-head'),
        msgs: document.getElementById('prev-msgs'),
        chatWin: document.getElementById('prev-chat'),
        inpArea: document.getElementById('prev-input-area'),
        userInp: document.getElementById('prev-in'),
        tmrDisplay: document.getElementById('prev-timer'),
        // settings
        accent: document.getElementById('inp-accent'),
        tmrOn: document.getElementById('inp-timer-on'),
        tmrMin: document.getElementById('inp-timer-min'),
        msgWin: document.getElementById('inp-win'),
        msgLose: document.getElementById('inp-lose'),
        code: document.getElementById('output-code'),
        copy: document.getElementById('btn-copy'),
        label: document.getElementById('label-img'),
        // audio preview
        auType: document.getElementById('prev-aud-type'),
        auClick: document.getElementById('prev-aud-click'),
        auPing: document.getElementById('prev-aud-ping')
    };

    // Setup preview audio
    els.auType.src = sType;
    els.auClick.src = sClick;
    els.auPing.src = sPing;

    // --- EDITOR LOGIC ---
    function renderQuests() {
        els.questCont.innerHTML = '';
        state.quests.forEach((q, i) => {
            const card = document.createElement('div'); card.className = 'q-card';
            
            // Header
            const head = document.createElement('div'); head.className = 'q-header';
            head.innerHTML = `<span class="q-type">${q.type === 'text' ? '‚úçÔ∏è –¢–µ–∫—Å—Ç' : 'üîò –í—ã–±–æ—Ä'}</span>`;
            const delBtn = document.createElement('button'); delBtn.className = 'q-del';
            delBtn.innerHTML = '√ó'; delBtn.onclick = () => { state.quests.splice(i, 1); renderQuests(); };
            head.appendChild(delBtn);
            card.appendChild(head);

            // Type
            const typeGrp = mkInpGroup('–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:');
            const sel = document.createElement('select'); sel.className = 'q-inp';
            sel.innerHTML = `<option value="text">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option><option value="choice">–í—ã–±–æ—Ä –∫–Ω–æ–ø–æ–∫</option>`;
            sel.value = q.type;
            sel.onchange = (e) => { state.quests[i].type = e.target.value; renderQuests(); };
            typeGrp.appendChild(sel);
            card.appendChild(typeGrp);

            // Question
            const qGrp = mkInpGroup('–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:');
            const inpQ = document.createElement('input'); inpQ.className = 'q-inp';
            inpQ.value = q.q; inpQ.oninput = (e) => state.quests[i].q = e.target.value;
            qGrp.appendChild(inpQ);
            card.appendChild(qGrp);

            // Media Buttons
            const mBar = document.createElement('div'); mBar.className = 'q-media-bar';
            
            // Image Upload
            const lbImg = document.createElement('label'); lbImg.className = 'media-btn' + (q.img ? ' active' : '');
            lbImg.innerHTML = `üñºÔ∏è ${q.img ? '–ï—Å—Ç—å —Ñ–æ—Ç–æ' : '–§–æ—Ç–æ'}`;
            const fiImg = document.createElement('input'); fiImg.type='file'; fiImg.accept='image/*'; fiImg.className='file-input';
            fiImg.onchange = (e) => updateQuestMedia(i, 'img', e.target.files[0]);
            lbImg.appendChild(fiImg);
            
            // Audio Upload
            const lbAud = document.createElement('label'); lbAud.className = 'media-btn' + (q.aud ? ' active' : '');
            lbAud.innerHTML = `üéµ ${q.aud ? '–ï—Å—Ç—å –∞—É–¥–∏–æ' : '–ê—É–¥–∏–æ'}`;
            const fiAud = document.createElement('input'); fiAud.type='file'; fiAud.accept='audio/*'; fiAud.className='file-input';
            fiAud.onchange = (e) => updateQuestMedia(i, 'aud', e.target.files[0]);
            lbAud.appendChild(fiAud);

            mBar.appendChild(lbImg); mBar.appendChild(lbAud);
            card.appendChild(mBar);

            // Options (if choice)
            if (q.type === 'choice') {
                const oGrp = mkInpGroup('–í–∞—Ä–∏–∞–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):');
                const inpO = document.createElement('input'); inpO.className = 'q-inp';
                inpO.value = q.opts; inpO.placeholder = "–î–∞,–ù–µ—Ç,–í–æ–∑–º–æ–∂–Ω–æ";
                inpO.oninput = (e) => state.quests[i].opts = e.target.value;
                oGrp.appendChild(inpO);
                card.appendChild(oGrp);
            }

            // Answer
            const aGrp = mkInpGroup('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—Ç–æ—á–Ω–æ):');
            const inpA = document.createElement('input'); inpA.className = 'q-inp';
            inpA.value = q.a; inpA.oninput = (e) => state.quests[i].a = e.target.value;
            aGrp.appendChild(inpA);
            card.appendChild(aGrp);

            els.questCont.appendChild(card);
        });
    }

    function mkInpGroup(label) {
        const d = document.createElement('div'); d.className = 'q-input-group';
        const l = document.createElement('span'); l.className = 'q-label'; l.innerText = label;
        d.appendChild(l); return d;
    }

    window.addQuest = () => {
        state.quests.push({ type: 'text', q: '', a: '', opts: '', img: null, aud: null });
        renderQuests();
    };

    window.updateQuestMedia = (idx, type, file) => {
        if(!file) return;
        if(file.size > 2*1024*1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>2MB)"); return; }
        const r = new FileReader();
        r.onload = v => {
            state.quests[idx][type] = v.target.result;
            renderQuests(); 
        };
        r.readAsDataURL(file);
    };

    els.imgInp.onchange = e => {
        const f = e.target.files[0];
        if(f) {
            const r = new FileReader();
            r.onload = v => {
                state.avatar = v.target.result;
                els.prevRing.src = state.avatar;
                els.prevHead.src = state.avatar;
                els.label.innerText = "‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ";
                if(state.chatOpen) startSim();
            };
            r.readAsDataURL(f);
        }
    };
    els.prevRing.src = state.avatar;
    els.prevHead.src = state.avatar;

    // --- PREVIEW LOGIC ---
    function playPrevSound(type) {
        const a = type===1 ? els.auClick : (type===2 ? els.auPing : els.auType);
        a.currentTime = 0;
        a.play().catch(e=>{});
    }

    window.toggleChat = () => {
        state.chatOpen = !state.chatOpen;
        if(state.chatOpen) {
            els.chatWin.classList.add('open');
            playPrevSound(1);
            startSim();
        } else {
            els.chatWin.classList.remove('open');
            clearInterval(state.interval);
        }
    };

    function startSim() {
        els.msgs.innerHTML = '';
        state.qIndex = 0;
        state.gameActive = true;
        clearInterval(state.interval);
        
        if(els.tmrOn.checked) {
            els.tmrDisplay.style.display = 'block';
            state.timerVal = parseInt(els.tmrMin.value) * 60;
            updTimerDisplay();
            state.interval = setInterval(() => {
                state.timerVal--;
                updTimerDisplay();
                if(state.timerVal <= 0) {
                    clearInterval(state.interval);
                    addMsg('bot', els.msgLose.value);
                    state.gameActive = false;
                    els.inpArea.style.display = 'none';
                }
            }, 1000);
        } else {
            els.tmrDisplay.style.display = 'none';
        }

        nextQ();
    }

    function updTimerDisplay() {
        const m = Math.floor(state.timerVal/60);
        const s = state.timerVal%60;
        els.tmrDisplay.innerText = (m<10?'0'+m:m) + ":" + (s<10?'0'+s:s);
    }

    function nextQ() {
        if(state.qIndex >= state.quests.length) {
            clearInterval(state.interval);
            addMsg('bot', els.msgWin.value);
            state.gameActive = false;
            els.inpArea.style.display = 'none';
            return;
        }

        const q = state.quests[state.qIndex];
        // Pass media to addMsg
        addMsg('bot', q.q, q.img, q.aud);
        
        if(q.type === 'choice') {
            els.inpArea.style.display = 'none';
            const div = document.createElement('div'); div.className='opt-row';
            const opts = q.opts.split(',');
            opts.forEach(o => {
                const b = document.createElement('button'); b.className='opt-btn'; b.innerText = o.trim();
                b.onclick = () => handleAns(o.trim());
                div.appendChild(b);
            });
            els.msgs.appendChild(div);
            els.msgs.scrollTop = els.msgs.scrollHeight;
        } else {
            els.inpArea.style.display = 'flex';
        }
    }

    window.simSend = () => {
        const v = els.userInp.value.trim();
        if(!v) return;
        handleAns(v);
        els.userInp.value = '';
    };

    function handleAns(ans) {
        if(!state.gameActive) return;
        
        playPrevSound(3); 
        addMsg('user', ans);
        
        const old = els.msgs.querySelectorAll('.opt-row');
        old.forEach(b => b.remove());

        const cor = state.quests[state.qIndex].a.trim().toLowerCase();
        if(ans.toLowerCase() === cor) {
            state.qIndex++;
            setTimeout(nextQ, 600);
        } else {
            state.gameActive = false;
            clearInterval(state.interval);
            els.inpArea.style.display = 'none';
            setTimeout(() => addMsg('bot', els.msgLose.value), 600);
        }
    }

    function addMsg(role, txt, img, aud) {
        if(role === 'bot') playPrevSound(2);

        const d = document.createElement('div'); d.className=`message msg-${role}`;
        const im = document.createElement('img'); im.className='msg-avatar'; im.src = role==='bot'?state.avatar:defUser;
        
        const cont = document.createElement('div'); cont.className = 'bubble-cont';
        
        const b = document.createElement('div'); b.className='bubble';
        if(role==='user') b.style.background = els.accent.value;
        b.innerText = txt;
        cont.appendChild(b);

        // Display Media in Preview
        if(img) {
            const md = document.createElement('div'); md.className='chat-media';
            md.innerHTML = `<img src="${img}">`;
            cont.appendChild(md);
        }
        if(aud) {
            const ad = document.createElement('audio'); ad.className='chat-audio';
            ad.controls=true; ad.src=aud;
            cont.appendChild(ad);
        }

        d.appendChild(im); d.appendChild(cont);
        if(role==='user') d.insertBefore(cont, im);
        els.msgs.appendChild(d);
        els.msgs.scrollTop = els.msgs.scrollHeight;
    }

    els.accent.oninput = () => document.querySelector('.send-btn').style.background = els.accent.value;
    renderQuests();

    // --- GENERATOR ---
    els.copy.onclick = () => {
        const code = generateCode();
        els.code.value = code;
        els.code.select();
        document.execCommand('copy');
        els.copy.innerText = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
        setTimeout(() => els.copy.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥", 2000);
    };

    function generateCode() {
        const uid = "quiz-" + Math.random().toString(36).substr(2,6);
        const data = {
            av: state.avatar,
            us: defUser,
            col: els.accent.value,
            qs: state.quests,
            tmr: els.tmrOn.checked,
            time: parseInt(els.tmrMin.value) * 60,
            win: els.msgWin.value,
            lose: els.msgLose.value,
            sClick: sClick, sPing: sPing, sType: sType
        };

        return `
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="margin:0;padding:0;width:100%;height:100%;background:transparent;overflow:hidden;font-family:sans-serif;">
<style>
* { box-sizing: border-box; }
#${uid} { width:100%; height:100%; display:flex; justify-content:center; align-items:center; position:relative; }
#${uid} .ring { width:90px; height:90px; border-radius:50%; background:#1E1234; border:3px solid rgba(255,255,255,0.3); cursor:pointer; display:flex; justify-content:center; align-items:center; box-shadow:0 5px 15px rgba(0,0,0,0.4); transition:0.3s; z-index:1; }
#${uid} .ring:hover { transform:scale(1.05); }
#${uid} .ring img { width:90%; height:90%; border-radius:50%; object-fit:cover; }

#${uid} .win { position:absolute; width:98%; height:98%; background:#120C1C; border-radius:15px; border:1px solid #3A2E59; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,0.6); opacity:0; pointer-events:none; transform:scale(0.9); transition:0.3s; z-index:2; color:#fff; }
#${uid} .win.show { opacity:1; pointer-events:all; transform:scale(1); }

#${uid} .head { padding:10px; background:rgba(255,255,255,0.05); border-bottom:1px solid #3A2E59; display:flex; justify-content:space-between; align-items:center; }
#${uid} .prof { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:bold; }
#${uid} .prof img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
#${uid} .tmr { font-family:monospace; background:#000; padding:2px 6px; border-radius:4px; color:${data.col}; display:${data.tmr ? 'block' : 'none'}; }
#${uid} .cls { background:none; border:none; color:#888; font-size:20px; cursor:pointer; }

#${uid} .logs { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; scrollbar-width:thin; }
#${uid} .row { display:flex; gap:6px; max-width:90%; align-items:flex-end; font-size:13px; line-height:1.4; }
#${uid} .bot { align-self:flex-start; }
#${uid} .usr { align-self:flex-end; flex-direction:row-reverse; }
#${uid} .av { width:24px; height:24px; border-radius:50%; object-fit:cover; flex-shrink:0; }
#${uid} .cnt { display:flex; flex-direction:column; gap:4px; max-width:100%; }
#${uid} .txt { padding:8px 12px; border-radius:15px; word-wrap:break-word; }
#${uid} .bot .txt { background:rgba(255,255,255,0.1); border-bottom-left-radius:2px; }
#${uid} .usr .txt { background:${data.col}; color:#fff; border-bottom-right-radius:2px; }

#${uid} .med { border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.2); margin-top:4px; }
#${uid} .med img { width:100%; display:block; }
#${uid} audio { width:100%; height:30px; margin-top:4px; }

#${uid} .opts { display:flex; flex-wrap:wrap; gap:6px; margin-left:34px; margin-top:-5px; }
#${uid} .btn-o { background:transparent; border:1px solid ${data.col}; color:white; padding:6px 12px; border-radius:15px; cursor:pointer; font-size:12px; }
#${uid} .btn-o:hover { background:${data.col}; }

#${uid} .inp { padding:8px; background:rgba(0,0,0,0.2); border-top:1px solid #3A2E59; display:flex; gap:6px; }
#${uid} input { flex:1; background:#0b0711; border:1px solid #3A2E59; border-radius:20px; padding:8px 12px; color:#fff; outline:none; }
#${uid} .snd { width:34px; height:34px; border-radius:50%; background:${data.col}; border:none; color:#fff; cursor:pointer; display:flex; justify-content:center; align-items:center; }
#${uid} .snd svg { width:16px; fill:white; margin-left:2px; }
</style>

<div id="${uid}">
    <div class="ring" id="r-${uid}"><img src="${data.av}"></div>
    <div class="win" id="w-${uid}">
        <div class="head">
            <div class="prof"><img src="${data.av}"><span>–ê–≤–∞—Ç–∞—Ä</span></div>
            <div class="tmr" id="t-${uid}">00:00</div>
            <button class="cls" id="c-${uid}">√ó</button>
        </div>
        <div class="logs" id="l-${uid}"></div>
        <div class="inp" id="ia-${uid}">
            <input type="text" id="i-${uid}" placeholder="–û—Ç–≤–µ—Ç...">
            <button class="snd" id="s-${uid}"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>
    <audio id="s1-${uid}" src="${data.sClick}"></audio>
    <audio id="s2-${uid}" src="${data.sPing}"></audio>
    <audio id="s3-${uid}" src="${data.sType}"></audio>
</div>

<script>
(function(){
    var C = ${JSON.stringify(data)};
    var r=document.getElementById('r-${uid}'), w=document.getElementById('w-${uid}'), c=document.getElementById('c-${uid}');
    var l=document.getElementById('l-${uid}'), ia=document.getElementById('ia-${uid}'), i=document.getElementById('i-${uid}');
    var s=document.getElementById('s-${uid}'), td=document.getElementById('t-${uid}');
    var s1=document.getElementById('s1-${uid}'), s2=document.getElementById('s2-${uid}'), s3=document.getElementById('s3-${uid}');
    
    var idx=0, act=false, iv=null, rem=0;

    r.onclick = function(){ w.classList.add('show'); r.style.opacity='0'; r.style.pointerEvents='none'; snd(1); if(!act) start(); };
    c.onclick = function(){ w.classList.remove('show'); r.style.opacity='1'; r.style.pointerEvents='all'; clearInterval(iv); };
    
    function snd(t){ var x=t==1?s1:(t==2?s2:s3); x.currentTime=0; x.play().catch(function(){}); }

    function add(who, txt, img, aud) {
        var d=document.createElement('div'); d.className='row '+who;
        var im=document.createElement('img'); im.className='av'; im.src=who==='bot'?C.av:C.us;
        var cnt=document.createElement('div'); cnt.className='cnt';
        
        var t=document.createElement('div'); t.className='txt'; t.innerText=txt;
        cnt.appendChild(t);

        if(img) { var md=document.createElement('div'); md.className='med'; md.innerHTML='<img src="'+img+'">'; cnt.appendChild(md); }
        if(aud) { var ad=document.createElement('audio'); ad.controls=true; ad.src=aud; cnt.appendChild(ad); }

        d.appendChild(im); d.appendChild(cnt); if(who==='usr') d.insertBefore(cnt, im);
        l.appendChild(d); l.scrollTop=l.scrollHeight;
    }

    function start() {
        idx=0; act=true; l.innerHTML='';
        if(C.tmr) { rem=C.time; updT(); iv=setInterval(function(){ rem--; updT(); if(rem<=0) end(false); }, 1000); }
        ask();
    }
    
    function updT() { var m=Math.floor(rem/60), sec=rem%60; td.innerText=(m<10?'0'+m:m)+':'+(sec<10?'0'+sec:sec); }

    function ask() {
        if(idx>=C.qs.length) { end(true); return; }
        var q=C.qs[idx];
        snd(2); add('bot', q.q, q.img, q.aud);
        
        var oo=l.querySelectorAll('.opts'); for(var k=0;k<oo.length;k++) oo[k].remove();

        if(q.type==='choice') {
            ia.style.display='none';
            var d=document.createElement('div'); d.className='opts';
            var ops=q.opts.split(',');
            for(var x=0;x<ops.length;x++) {
                var b=document.createElement('button'); b.className='btn-o'; b.innerText=ops[x].trim();
                (function(v){ b.onclick=function(){ ans(v); } })(ops[x].trim());
                d.appendChild(b);
            }
            l.appendChild(d); l.scrollTop=l.scrollHeight;
        } else {
            ia.style.display='flex';
        }
    }

    function ans(v) {
        if(!act) return;
        snd(3); add('usr', v);
        var cor = C.qs[idx].a.trim().toLowerCase();
        var oo=l.querySelectorAll('.opts'); for(var k=0;k<oo.length;k++) oo[k].remove();
        
        if(v.toLowerCase()===cor) {
            idx++; setTimeout(ask, 600);
        } else {
            setTimeout(function(){ end(false); }, 600);
        }
    }

    function end(win) {
        act=false; clearInterval(iv); ia.style.display='none';
        var oo=l.querySelectorAll('.opts'); for(var k=0;k<oo.length;k++) oo[k].remove();
        snd(2); add('bot', win ? C.win : C.lose);
    }

    s.onclick=function(){ var v=i.value.trim(); if(v){ i.value=''; ans(v); } };
    i.onkeypress=function(e){ if(e.key==='Enter') s.onclick(); };

})();
<\/script>
</body>
</html>`;
    }
</script>
</body>
</html>
                   
