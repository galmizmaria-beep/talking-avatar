<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор Аватара-Плеера для Genially</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #120C1C;
            --surface-color: #1E1234;
            --primary-color: #A450F3;
            --accent-color: #F72585;
            --text-color: #EAE2FF;
            --border-color: #3A2E59;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #editor-container { max-width: 950px; width: 100%; background-color: var(--surface-color); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 40px var(--primary-color) inset; border: 1px solid var(--border-color); }
        h1, h2 { text-align: center; color: var(--text-color); font-weight: 700; text-shadow: 0 0 10px var(--accent-color); }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.5em; margin-bottom: 25px;}
        .editor-layout { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px; }
        .preview-column, .settings-column { flex: 1; min-width: 350px; padding: 25px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.2); border-radius: 15px; }
        #preview-area { display: flex; justify-content: center; align-items: center; height: 380px; margin-bottom: 20px; }
        #avatar-container { display: flex; justify-content: center; align-items: center; transition: all 0.3s ease; position: relative; width: 250px; height: 250px; }
        #image-placeholder { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; border: 3px dashed var(--border-color); border-radius: 50%; color: #aaa; text-align: center; font-size: 1.2em; }
        #avatar-image { border-radius: 50%; object-fit: cover; width: 100%; height: 100%; border: 4px solid var(--border-color); box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: none; }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 20px; }
        .player-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; color: var(--text-color); transition: color 0.3s, transform 0.2s; }
        .player-btn:hover { color: var(--accent-color); transform: scale(1.1); }
        .player-btn svg { width: 32px; height: 32px; }
        #btn-play-pause { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(145deg, var(--primary-color), var(--accent-color)); box-shadow: 0 0 20px var(--primary-color); }
        #btn-play-pause:hover { box-shadow: 0 0 30px var(--accent-color); }
        #btn-play-pause svg { width: 36px; height: 36px; }
        .settings-column label { display: block; margin-top: 20px; margin-bottom: 8px; font-weight: 600; font-size: 1em; color: var(--text-color); }
        .file-label { display: block; background: var(--bg-color); border: 2px dashed var(--border-color); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; }
        .file-label:hover { background-color: var(--border-color); border-color: var(--primary-color); }
        input[type="file"] { display: none; }
        .file-name { font-size: 0.9em; color: #aaa; margin-top: 5px; }
        .code-generation { margin-top: 30px; text-align: center; }
        #get-code-btn { background: linear-gradient(145deg, var(--primary-color), var(--accent-color)); color: white; padding: 15px 35px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1em; font-weight: 600; margin-bottom: 20px; transition: all 0.3s; box-shadow: 0 0 15px var(--primary-color); }
        #get-code-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--accent-color); }
        #get-code-btn.ready { background: #28a745; box-shadow: 0 0 15px #28a745; font-size: 1em; }
        #generated-code { width: 100%; height: 150px; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 15px; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; resize: vertical; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="editor-container">
        <h1>РЕДАКТОР АВАТАРА-ПЛЕЕРА</h1>
        <div class="editor-layout">
            <div class="preview-column">
                <h2>ПРЕДПРОСМОТР</h2>
                <div id="preview-area">
                    <div id="avatar-container">
                        <div id="image-placeholder">Предпросмотр<br>аватара</div>
                        <img id="avatar-image" alt="Аватар">
                    </div>
                </div>
                <div class="player-controls">
                     <button id="btn-backward" class="player-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
                    <button id="btn-play-pause" class="player-btn"></button>
                    <button id="btn-forward" class="player-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
                </div>
            </div>
            <div class="settings-column">
                <h2>НАСТРОЙКИ</h2>
                <label for="image-upload" class="file-label">Нажмите, чтобы загрузить изображение
                    <input type="file" id="image-upload" accept="image/*">
                    <div id="image-file-name" class="file-name">Файл не выбран</div>
                </label>
                <label for="audio-upload" class="file-label">Нажмите, чтобы загрузить аудио
                    <input type="file" id="audio-upload" accept="audio/*,video/mp4">
                    <div id="audio-file-name" class="file-name">Файл не выбран</div>
                </label>
                <label for="size-slider">Размер виджета: <span id="size-value">250px</span></label>
                <input type="range" id="size-slider" min="150" max="400" value="250">
                <label for="glow-color">Цвет свечения</label>
                <input type="color" id="glow-color" value="#F72585">
                <label for="glow-intensity-slider">Интенсивность свечения: <span id="glow-intensity-value">10</span></label>
                <input type="range" id="glow-intensity-slider" min="1" max="20" value="10">
            </div>
        </div>
        <div class="code-generation">
            <button id="get-code-btn">Получить код для Genially</button>
            <textarea id="generated-code" readonly placeholder="Ваш HTML-код для Genially появится здесь..."></textarea>
        </div>
    </div>
    <audio id="audio-player" style="display:none;"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getCodeBtn = document.getElementById('get-code-btn');
            const generatedCode = document.getElementById('generated-code');
            const imageUpload = document.getElementById('image-upload');
            const audioUpload = document.getElementById('audio-upload');
            const imageFileName = document.getElementById('image-file-name');
            const audioFileName = document.getElementById('audio-file-name');
            const sizeSlider = document.getElementById('size-slider');
            const sizeValue = document.getElementById('size-value');
            const glowColorInput = document.getElementById('glow-color');
            const glowIntensitySlider = document.getElementById('glow-intensity-slider');
            const glowIntensityValue = document.getElementById('glow-intensity-value');
            const avatarContainer = document.getElementById('avatar-container');
            const imagePlaceholder = document.getElementById('image-placeholder');
            const avatarImage = document.getElementById('avatar-image');
            const audioPlayer = document.getElementById('audio-player');
            const btnPlayPause = document.getElementById('btn-play-pause');
            const btnBackward = document.getElementById('btn-backward');
            const btnForward = document.getElementById('btn-forward');

            const playIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
            const pauseIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
            let imageDataUrl = '';
            let audioDataUrl = '';
            const originalButtonText = getCodeBtn.textContent;

            btnPlayPause.innerHTML = playIcon;

            const handleFileSelect = (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'image') {
                        imageDataUrl = e.target.result;
                        avatarImage.src = imageDataUrl;
                        imagePlaceholder.style.display = 'none';
                        avatarImage.style.display = 'block';
                        imageFileName.textContent = file.name;
                    } else if (type === 'audio') {
                        audioDataUrl = e.target.result;
                        audioPlayer.src = audioDataUrl;
                        audioFileName.textContent = file.name;
                    }
                    getCodeBtn.textContent = originalButtonText;
                    getCodeBtn.classList.remove('ready');
                };
                reader.readAsDataURL(file);
            };
            
            imageUpload.addEventListener('change', (e) => handleFileSelect(e, 'image'));
            audioUpload.addEventListener('change', (e) => handleFileSelect(e, 'audio'));
            
            sizeSlider.addEventListener('input', (e) => {
                const size = e.target.value;
                const avatarPreviewSize = size * 0.7;
                avatarContainer.style.width = `${avatarPreviewSize}px`;
                avatarContainer.style.height = `${avatarPreviewSize}px`;
                sizeValue.textContent = `${size}px`;
            });
            sizeSlider.dispatchEvent(new Event('input'));
            
            const updatePreviewGlow = () => {
                const color = glowColorInput.value;
                const intensity = glowIntensitySlider.value;
                avatarContainer.style.filter = `drop-shadow(0 0 ${intensity * 1.5}px ${color})`;
            };
            
            [glowColorInput, glowIntensitySlider].forEach(el => el.addEventListener('input', updatePreviewGlow));
            glowIntensitySlider.addEventListener('input', (e) => glowIntensityValue.textContent = e.target.value);
            updatePreviewGlow();
            
            btnPlayPause.addEventListener('click', () => { if (!audioPlayer.src) return; if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause(); });
            audioPlayer.addEventListener('play', () => btnPlayPause.innerHTML = pauseIcon);
            audioPlayer.addEventListener('pause', () => btnPlayPause.innerHTML = playIcon);
            audioPlayer.addEventListener('ended', () => btnPlayPause.innerHTML = playIcon);
            btnBackward.addEventListener('click', () => { if(audioPlayer.src) audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5); });
            btnForward.addEventListener('click', () => { if(audioPlayer.src) audioPlayer.currentTime += 5; });

            // ГЕНЕРАЦИЯ КОДА (ИСПРАВЛЕННАЯ ЛОГИКА)
            getCodeBtn.addEventListener('click', () => {
                if (!imageDataUrl || !audioDataUrl) {
                    alert('Пожалуйста, загрузите и изображение, и аудиофайл.');
                    return;
                }

                const size = sizeSlider.value;
                const glowColor = glowColorInput.value;
                const intensity = glowIntensitySlider.value;
                const blur = 10 + parseFloat(intensity) * 1.5;
                
                // Вместо iframe генерируем автономный блок div+script
                const standaloneCode = `
<div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: transparent;">
    <style>
        .gen-player-widget {
            --glow-c: ${glowColor};
            --blur-v: ${blur}px;
            width: ${size}px;
            height: ${size}px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: sans-serif;
        }
        .gen-avatar-wrapper {
            width: 70%;
            height: 70%;
            border-radius: 50%;
            padding: 5px;
            position: relative;
            transition: filter .4s ease;
            cursor: pointer;
        }
        .gen-avatar-wrapper.speaking {
            filter: drop-shadow(0 0 var(--blur-v) var(--glow-c));
        }
        .gen-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }
        .gen-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        .gen-ctrl-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: all .3s;
        }
        .gen-ctrl-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .gen-ctrl-btn svg { width: 28px; height: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .gen-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(145deg, #a960ec, #f72585);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .gen-play-btn svg { width: 30px; height: 30px; margin-left: 2px; }
    </style>

    <div class="gen-player-widget" id="widget-${Date.now()}">
        <div class="gen-avatar-wrapper">
            <img class="gen-avatar-img" src="${imageDataUrl}">
        </div>
        <div class="gen-controls">
            <button class="gen-ctrl-btn prev-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
            <button class="gen-ctrl-btn gen-play-btn"></button>
            <button class="gen-ctrl-btn next-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
        </div>
        <audio style="display:none;" src="${audioDataUrl}"></audio>
    </div>

    <script>
        (function() {
            // Изолированная область видимости
            const root = document.currentScript.previousElementSibling; 
            const wrapper = root.querySelector('.gen-avatar-wrapper');
            const img = root.querySelector('.gen-avatar-img');
            const playBtn = root.querySelector('.gen-play-btn');
            const prevBtn = root.querySelector('.prev-btn');
            const nextBtn = root.querySelector('.next-btn');
            const audio = root.querySelector('audio');
            
            const playIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            const pauseIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            
            playBtn.innerHTML = playIcon;

            const togglePlay = () => {
                if(audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            };

            playBtn.addEventListener('click', togglePlay);
            wrapper.addEventListener('click', togglePlay);
            img.addEventListener('click', togglePlay);

            prevBtn.addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 5); });
            nextBtn.addEventListener('click', () => { audio.currentTime += 5; });

            audio.addEventListener('play', () => {
                playBtn.innerHTML = pauseIcon;
                wrapper.classList.add('speaking');
            });
            
            audio.addEventListener('pause', () => {
                playBtn.innerHTML = playIcon;
                wrapper.classList.remove('speaking');
            });
            
            audio.addEventListener('ended', () => {
                playBtn.innerHTML = playIcon;
                wrapper.classList.remove('speaking');
            });
        })();
    <\/script>
</div>`;

                generatedCode.value = standaloneCode;
                generatedCode.select();
                
                const copyToClipboard = () => {
                    getCodeBtn.textContent = 'Код скопирован!';
                    getCodeBtn.classList.add('ready');
                };
                const failCopy = () => {
                    getCodeBtn.textContent = 'Код готов! Скопируйте (Ctrl+C)';
                    getCodeBtn.classList.add('ready');
                };

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(standaloneCode).then(copyToClipboard).catch(failCopy);
                } else {
                    try {
                        document.execCommand('copy');
                        copyToClipboard();
                    } catch (e) {
                        failCopy();
                    }
                }
            });
        });
    </script>
</body>
</html>
